name: "æ„å»ºå‹åWR1200JS Pluså¢å¼ºç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05'
        type: choice
        options:
        - '23.05'
        - '22.03'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  CONFIG_FILE: configs/youhua/plus.config
  TARGET: ramips
  SUBTARGET: mt7621
  PROFILE: youhua_wr1200js
  DEVICE_NAME: "å‹åWR1200JS Plusç‰ˆ"

jobs:
  build-youhua-plus:
    runs-on: ubuntu-22.04
    timeout-minutes: 150  # Plusç‰ˆå¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
    
    steps:
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        echo "=== éªŒè¯å‹åWR1200JS Plusé…ç½® ==="
        ls -la configs/youhua/
        echo ""
        echo "é…ç½®é¢„è§ˆ:"
        head -50 "$CONFIG_FILE"
        echo ""
        echo "æ£€æŸ¥åˆ†åŒºå¤§å°:"
        grep "CONFIG_TARGET_ROOTFS_PARTSIZE" "$CONFIG_FILE" || echo "ä½¿ç”¨é»˜è®¤åˆ†åŒºå¤§å°"
        echo ""
        echo "åŒ…æ•°é‡ç»Ÿè®¡:"
        grep "^CONFIG_PACKAGE_" "$CONFIG_FILE" | wc -l

    - name: è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt \
          libelf-dev \
          ccache  # æ·»åŠ ccacheåŠ é€Ÿç¼–è¯‘

    - name: è®¾ç½®ccacheç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-youhua-plus-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-ccache-youhua-plus-

    - name: å…‹éš†OpenWrtæºç 
      run: |
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "æ­£åœ¨å…‹éš†OpenWrt $BRANCH åˆ†æ”¯ï¼Œä¸º $DEVICE_NAME æ„å»º..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-youhua-plus

    - name: é…ç½®Feedsï¼ˆè½¯ä»¶æºï¼‰
      run: |
        cd openwrt-youhua-plus
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "src-git packages https://git.openwrt.org/feed/packages.git;$BRANCH" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;$BRANCH" >> feeds.conf
        echo "src-git routing https://git.openwrt.org/feed/routing.git;$BRANCH" >> feeds.conf
        echo "src-git telephony https://git.openwrt.org/feed/telephony.git;$BRANCH" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åº”ç”¨Plusé…ç½®
      run: |
        cd openwrt-youhua-plus
        cp ../$CONFIG_FILE .config
        make defconfig
        echo "=== $DEVICE_NAME æœ€ç»ˆé…ç½®æ£€æŸ¥ ==="
        echo "1. è®¾å¤‡ç¡®è®¤:"
        grep "CONFIG_TARGET.*DEVICE.*youhua" .config || echo "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®"
        echo ""
        echo "2. åˆ†åŒºè®¾ç½®:"
        grep "CONFIG_TARGET.*PARTSIZE" .config || echo "âš ï¸ æœªæ‰¾åˆ°åˆ†åŒºè®¾ç½®"
        echo ""
        echo "3. æ ¸å¿ƒæ’ä»¶æ£€æŸ¥:"
        for pkg in luci-app-turboacc luci-app-upnp luci-app-ddns; do
          if grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "âœ… $pkg"
          else
            echo "âŒ $pkg"
          fi
        done
        echo ""
        echo "4. é…ç½®ç»Ÿè®¡:"
        echo "æ€»é…ç½®è¡Œæ•°: $(wc -l < .config)"
        echo "åŒ…é…ç½®æ•°é‡: $(grep "^CONFIG_PACKAGE_" .config | wc -l)"

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt-youhua-plus
        echo "å¼€å§‹ä¸‹è½½Plusç‰ˆæ‰€éœ€çš„è½¯ä»¶åŒ…..."
        make -j$(nproc) download
        # æ¸…ç†å¯èƒ½æŸåçš„å°æ–‡ä»¶
        find dl -size -1024c -exec rm -f {} \;
        echo "ä¸‹è½½å®Œæˆ"

    - name: ç¼–è¯‘OpenWrtå›ºä»¶
      run: |
        cd openwrt-youhua-plus
        echo "å¼€å§‹ä¸º $DEVICE_NAME ç¼–è¯‘å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…..."
        echo "é¢„è®¡æ—¶é—´: 90-120åˆ†é’Ÿ"
        
        # å¯ç”¨ccache
        export CCACHE_DIR="$HOME/.ccache"
        export CCACHE_MAXSIZE=2G
        
        # ç¼–è¯‘å¹¶è®°å½•æ—¶é—´
        time make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        echo "=== ç¼–è¯‘å®Œæˆ ==="

    - name: æ£€æŸ¥ç¼–è¯‘ç»“æœ
      run: |
        cd openwrt-youhua-plus
        echo "=== æ£€æŸ¥ç¼–è¯‘ç»“æœ ==="
        
        # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯
        if grep -q "Error" build.log; then
          echo "âŒ ç¼–è¯‘æ—¥å¿—ä¸­å‘ç°é”™è¯¯:"
          grep -A5 -B5 "Error" build.log | head -50
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
          exit 1
        fi
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_DIR="bin/targets/$TARGET/$SUBTARGET"
        if [ -d "$FIRMWARE_DIR" ]; then
          echo "âœ… å›ºä»¶ç›®å½•å­˜åœ¨"
          echo "ç›®å½•å†…å®¹:"
          ls -la "$FIRMWARE_DIR/"
          
          FIRMWARE_FILES=$(find "$FIRMWARE_DIR" -name "*.bin" -o -name "*.img")
          if [ -n "$FIRMWARE_FILES" ]; then
            echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
            for f in $FIRMWARE_FILES; do
              echo "- $(basename "$f") ($(ls -lh "$f" | awk '{print $5}'))"
            done
            echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
            
            # å¤åˆ¶å›ºä»¶åˆ°ç‹¬ç«‹ç›®å½•
            mkdir -p ../firmware-youhua-plus
            cp $FIRMWARE_FILES ../firmware-youhua-plus/
          else
            echo "âš ï¸ ç›®å½•ä¸­æ²¡æœ‰æ‰¾åˆ°.binæˆ–.imgæ–‡ä»¶"
            echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
          fi
        else
          echo "âŒ å›ºä»¶ç›®å½•ä¸å­˜åœ¨: $FIRMWARE_DIR"
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      if: env.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: youhua-wr1200js-plus-firmware
        path: firmware-youhua-plus/*
        retention-days: 7
        if-no-files-found: error

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-youhua-plus
        path: openwrt-youhua-plus/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶å¿«ç…§
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youhua-plus-config-snapshot
        path: |
          configs/youhua/plus.config
          configs/youhua/plus.diff
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ‘˜è¦
      if: always()
      run: |
        echo "=== å‹åWR1200JS Plusç‰ˆæ„å»ºæ‘˜è¦ ==="
        echo "è®¾å¤‡: $DEVICE_NAME"
        echo "OpenWrtç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        echo "æ„å»ºæ—¶é—´: $(date)"
        echo "æ„å»ºçŠ¶æ€: ${{ env.BUILD_SUCCESS || 'æœªçŸ¥' }}"
        echo "Runner: ${{ runner.os }}"
        echo "====================================="
