name: "æ„å»ºå‹åWR1200JSå¢å¼ºç‰ˆï¼ˆè°ƒè¯•ç‰ˆï¼‰"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05'
        type: choice
        options:
        - '23.05'
        - '22.03'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  CONFIG_FILE: configs/youhua/plus.config

jobs:
  build-youhua-plus:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: 2. æ˜¾ç¤ºé…ç½®è¯¦æƒ…
      run: |
        echo "=== é…ç½®æ–‡ä»¶åˆ†æ ==="
        echo "æ–‡ä»¶: $CONFIG_FILE"
        echo ""
        
        echo "ã€è®¾å¤‡é…ç½®ã€‘"
        grep "CONFIG_TARGET.*DEVICE" "$CONFIG_FILE" || echo "æœªæ‰¾åˆ°è®¾å¤‡é…ç½®"
        echo ""
        
        echo "ã€ç›®æ ‡å¹³å°ã€‘"
        grep "^CONFIG_TARGET_" "$CONFIG_FILE" | grep "=y" || echo "æœªæ‰¾åˆ°ç›®æ ‡å¹³å°"
        echo ""
        
        echo "ã€å…³é”®æ’ä»¶ã€‘"
        grep "^CONFIG_PACKAGE_luci-app-" "$CONFIG_FILE" | head -15
        echo ""

    - name: 3. è®¾ç½®ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt \
          libelf-dev

    - name: 4. å…‹éš†æºç 
      run: |
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "å…‹éš† $BRANCH ..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-youhua

    - name: 5. é…ç½®Feeds
      run: |
        cd openwrt-youhua
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "é…ç½®feeds..."
        echo "src-git packages https://git.openwrt.org/feed/packages.git;$BRANCH" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;$BRANCH" >> feeds.conf
        echo "src-git routing https://git.openwrt.org/feed/routing.git;$BRANCH" >> feeds.conf
        cat feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: 6. åº”ç”¨é…ç½®å¹¶è¯¦ç»†æ£€æŸ¥
      run: |
        cd openwrt-youhua
        echo "åº”ç”¨é…ç½®..."
        cp ../$CONFIG_FILE .config
        
        echo "è¿è¡Œ defconfig..."
        make defconfig
        
        echo "=== æœ€ç»ˆé…ç½®éªŒè¯ ==="
        echo ""
        echo "ã€1. è®¾å¤‡ç¡®è®¤ã€‘"
        DEVICE_LINE=$(grep "CONFIG_TARGET.*DEVICE.*=y" .config)
        if [ -n "$DEVICE_LINE" ]; then
          echo "âœ… è®¾å¤‡é…ç½®: $DEVICE_LINE"
        else
          echo "âŒ é”™è¯¯ï¼šæ²¡æœ‰è®¾å¤‡è¢«é€‰ä¸­ï¼"
          echo "å½“å‰è®¾å¤‡é€‰é¡¹:"
          grep "CONFIG_TARGET.*DEVICE" .config | head -20
          echo "è¯·ç¡®ä¿ CONFIG_TARGET_ramips_mt7621_DEVICE_youhua_wr1200js=y"
        fi
        
        echo ""
        echo "ã€2. ç›®æ ‡å¹³å°ã€‘"
        if grep -q "CONFIG_TARGET_ramips=y" .config && grep -q "CONFIG_TARGET_ramips_mt7621=y" .config; then
          echo "âœ… ç›®æ ‡å¹³å°: ramips/mt7621"
        else
          echo "âŒ ç›®æ ‡å¹³å°é…ç½®é”™è¯¯"
        fi
        
        echo ""
        echo "ã€3. é•œåƒè®¾ç½®ã€‘"
        if grep -q "CONFIG_TARGET_ROOTFS_SQUASHFS=y" .config; then
          echo "âœ… ä½¿ç”¨SQUASHFSæ–‡ä»¶ç³»ç»Ÿ"
        else
          echo "âŒ æœªè®¾ç½®SQUASHFS"
        fi
        
        echo ""
        echo "ã€4. é…ç½®ä¿å­˜ç”¨äºè°ƒè¯•ã€‘"
        cp .config ../final-config-debug.txt
        echo "æœ€ç»ˆé…ç½®å·²ä¿å­˜ä¸º final-config-debug.txt"

    - name: 7. ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt-youhua
        echo "ä¸‹è½½è½¯ä»¶åŒ…..."
        make -j$(nproc) download 2>&1 | tee download.log
        echo "ä¸‹è½½å®Œæˆ"

    - name: 8. ç¼–è¯‘å›ºä»¶
      run: |
        cd openwrt-youhua
        echo "å¼€å§‹ç¼–è¯‘..."
        echo "æ³¨æ„ï¼šè¿™éœ€è¦1-2å°æ—¶"
        
        START=$(date +%s)
        make -j$(($(nproc))) V=s 2>&1 | tee build.log
        END=$(date +%s)
        
        echo "ç¼–è¯‘å®Œæˆï¼Œè€—æ—¶: $(( (END - START) / 60 ))åˆ†é’Ÿ"
        
        if tail -50 build.log | grep -q "Signing package index"; then
          echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆ"
          echo "BUILD_COMPLETE=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ æœªæ‰¾åˆ°æˆåŠŸæ ‡è®°"
          echo "BUILD_COMPLETE=false" >> $GITHUB_ENV
        fi

    - name: 9. æ·±åº¦æ£€æŸ¥å›ºä»¶ç”Ÿæˆ
      run: |
        cd openwrt-youhua
        echo "=== æ·±åº¦æ£€æŸ¥å›ºä»¶ç”Ÿæˆ ==="
        echo ""
        
        echo "ã€1. æ•´ä¸ªbinç›®å½•ç»“æ„ã€‘"
        if [ -d "bin" ]; then
          find bin -type d 2>/dev/null | sort | head -30
        else
          echo "binç›®å½•ä¸å­˜åœ¨"
        fi
        echo ""
        
        echo "ã€2. targetsç›®å½•ã€‘"
        if [ -d "bin/targets" ]; then
          echo "bin/targets å­˜åœ¨ï¼Œå†…å®¹:"
          ls -la bin/targets/
          echo ""
          
          if [ -d "bin/targets/ramips" ]; then
            echo "bin/targets/ramips å­˜åœ¨ï¼Œå†…å®¹:"
            ls -la bin/targets/ramips/
            echo ""
            
            if [ -d "bin/targets/ramips/mt7621" ]; then
              echo "âœ… æ‰¾åˆ°ç›®æ ‡ç›®å½•: bin/targets/ramips/mt7621"
              echo "ç›®å½•å†…å®¹:"
              ls -la bin/targets/ramips/mt7621/
              echo ""
              
              echo "æŸ¥æ‰¾.binå’Œ.imgæ–‡ä»¶:"
              for file in bin/targets/ramips/mt7621/*.bin bin/targets/ramips/mt7621/*.img; do
                if [ -f "$file" ]; then
                  echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶: $file"
                  SIZE=$(ls -lh "$file" | awk '{print $5}')
                  echo "    å¤§å°: $SIZE"
                  mkdir -p ../firmware-output
                  cp "$file" ../firmware-output/
                  echo "FIRMWARE_FOUND=true" >> $GITHUB_ENV
                fi
              done
            else
              echo "âŒ bin/targets/ramips/mt7621 ç›®å½•ä¸å­˜åœ¨"
            fi
          else
            echo "âŒ bin/targets/ramips ç›®å½•ä¸å­˜åœ¨"
          fi
        else
          echo "âŒ bin/targets ç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "ã€3. æœç´¢æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶ã€‘"
        find . -type f \( -name "*.bin" -o -name "*.img" -o -name "*.trx" \) 2>/dev/null | \
          grep -v "\.git" | \
          grep -v "build_dir" | \
          head -20 || echo "æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
        
        echo ""
        echo "ã€4. æ£€æŸ¥ç¼–è¯‘æ—¥å¿—å°¾éƒ¨ã€‘"
        tail -100 build.log | grep -i "error\|fail\|warning\|youhua\|wr1200" || echo "æ—¥å¿—å°¾éƒ¨æ— ç›¸å…³å…³é”®è¯"

    - name: 10. ä¸Šä¼ æ‰¾åˆ°çš„å›ºä»¶
      if: env.FIRMWARE_FOUND == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: youhua-wr1200js-firmware-debug
        path: firmware-output/*
        retention-days: 7

    - name: 11. ä¸Šä¼ è°ƒè¯•æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youhua-debug-files
        path: |
          openwrt-youhua/build.log
          openwrt-youhua/download.log
          final-config-debug.txt
        retention-days: 7

    - name: 12. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
      if: always()
      run: |
        echo "=== å‹åWR1200JSæ„å»ºè¯Šæ–­æŠ¥å‘Š ==="
        echo "æ—¶é—´: $(date)"
        echo "é…ç½®æ–‡ä»¶: $CONFIG_FILE"
        echo "ç¼–è¯‘å®Œæˆ: ${{ env.BUILD_COMPLETE || 'æœªçŸ¥' }}"
        echo "æ‰¾åˆ°å›ºä»¶: ${{ env.FIRMWARE_FOUND || 'å¦' }}"
        echo ""
        
        if [ "${{ env.FIRMWARE_FOUND }}" = "true" ]; then
          echo "âœ… æˆåŠŸï¼å›ºä»¶å·²ç”Ÿæˆ"
          echo "ä¸‹è½½: youhua-wr1200js-firmware-debug"
        else
          echo "âŒ é—®é¢˜ï¼šç¼–è¯‘æˆåŠŸä½†æ— å›ºä»¶"
          echo ""
          echo "å¯èƒ½åŸå› å’Œè§£å†³æ–¹æ¡ˆï¼š"
          echo ""
          echo "ã€åŸå› 1ã€‘è®¾å¤‡åç§°é”™è¯¯"
          echo "  è§£å†³æ–¹æ¡ˆï¼š"
          echo "  1. æŸ¥çœ‹OpenWrtæºç ä¸­çš„è®¾å¤‡å®šä¹‰"
          echo "  2. å°è¯•ä¸åŒè®¾å¤‡åç§°æ ¼å¼"
          echo ""
          echo "ã€åŸå› 2ã€‘é…ç½®æ–‡ä»¶ä¸å®Œæ•´"
          echo "  è§£å†³æ–¹æ¡ˆï¼š"
          echo "  1. æ£€æŸ¥final-config-debug.txtä¸­çš„é…ç½®"
          echo "  2. ç¡®ä¿æ‰€æœ‰å¿…è¦çš„é…ç½®éƒ½è®¾ç½®ä¸ºy"
          echo ""
          echo "è¯·ä¸‹è½½ youhua-debug-files è¿›è¡Œè¯¦ç»†åˆ†æ"
        fi
