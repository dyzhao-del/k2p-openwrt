name: "友华WR1200JS调试构建"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrt版本'
        required: true
        default: '23.05'
        type: choice
        options:
        - '23.05'
        - '22.03'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git

jobs:
  debug-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
    
    - name: 2. 检查配置文件
      run: |
        echo "检查配置文件..."
        CONFIG_FILE="configs/youhua/plus.config"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "配置文件: $CONFIG_FILE"
          echo "设备配置:"
          grep "CONFIG_TARGET.*DEVICE" "$CONFIG_FILE" || echo "未找到设备配置"
          echo ""
          echo "文件大小: $(wc -l < "$CONFIG_FILE") 行"
        else
          echo "错误: $CONFIG_FILE 不存在"
          exit 1
        fi
    
    - name: 3. 设置环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils python3-pip rsync unzip zlib1g-dev file wget quilt libelf-dev
    
    - name: 4. 克隆源码
      run: |
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "克隆 $BRANCH 分支..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-youhua
    
    - name: 5. 配置Feeds
      run: |
        cd openwrt-youhua
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "src-git packages https://git.openwrt.org/feed/packages.git;$BRANCH" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;$BRANCH" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: 6. 应用配置
      run: |
        cd openwrt-youhua
        CONFIG_FILE="configs/youhua/plus.config"
        echo "应用配置..."
        cp ../$CONFIG_FILE .config
        make defconfig
        echo "配置应用完成"
        
        echo "当前设备配置:"
        grep "CONFIG_TARGET.*DEVICE.*=y" .config || echo "未找到设备配置"
    
    - name: 7. 下载软件包
      run: |
        cd openwrt-youhua
        echo "下载软件包..."
        make -j$(nproc) download
        echo "下载完成"
    
    - name: 8. 编译
      run: |
        cd openwrt-youhua
        echo "开始编译..."
        make -j$(($(nproc))) V=s 2>&1 | tee build.log
        echo "编译命令执行完成"
        
        # 检查是否找到成功标记
        if grep -q "Signing package index" build.log; then
          echo "✅ 编译成功完成"
        else
          echo "⚠️ 未找到成功标记"
        fi
    
    - name: 9. 检查固件
      run: |
        cd openwrt-youhua
        echo "检查生成的固件..."
        
        TARGET_DIR="bin/targets/ramips/mt7621"
        if [ -d "$TARGET_DIR" ]; then
          echo "目标目录存在: $TARGET_DIR"
          ls -la "$TARGET_DIR/"
          
          # 查找固件
          FIRMWARE=$(find "$TARGET_DIR" -name "*.bin" -o -name "*.img" | head -1)
          if [ -n "$FIRMWARE" ]; then
            echo "✅ 找到固件: $FIRMWARE"
            mkdir -p ../firmware-output
            cp "$FIRMWARE" ../firmware-output/
            echo "FIRMWARE_FOUND=true" >> $GITHUB_ENV
          else
            echo "❌ 未找到固件文件"
            echo "FIRMWARE_FOUND=false" >> $GITHUB_ENV
          fi
        else
          echo "❌ 目标目录不存在: $TARGET_DIR"
          echo "FIRMWARE_FOUND=false" >> $GITHUB_ENV
        fi
    
    - name: 10. 上传固件
      if: env.FIRMWARE_FOUND == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: youhua-firmware
        path: firmware-output/*
        retention-days: 7
    
    - name: 11. 上传日志
      uses: actions/upload-artifact@v4
      with:
        name: youhua-build-log
        path: openwrt-youhua/build.log
        retention-days: 7
    
    - name: 12. 报告
      run: |
        echo "=== 构建报告 ==="
        echo "时间: $(date)"
        echo "版本: ${{ github.event.inputs.version }}"
        echo "找到固件: ${{ env.FIRMWARE_FOUND || '未知' }}"
        
        if [ "${{ env.FIRMWARE_FOUND }}" = "true" ]; then
          echo "✅ 构建成功"
        else
          echo "❌ 构建失败或未生成固件"
          echo "可能原因: 设备名称配置错误"
        fi
