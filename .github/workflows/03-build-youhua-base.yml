name: "æ„å»ºå‹åWR1200JSåŸºç¡€å›ºä»¶"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05'
        type: choice
        options:
        - '23.05'
        - '22.03'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  CONFIG_FILE: configs/youhua/base.config
  TARGET: ramips
  SUBTARGET: mt7621
  PROFILE: youhua_wr1200js
  DEVICE_NAME: "å‹åWR1200JS"

jobs:
  build-youhua-base:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: æ£€å‡ºä»“åº“ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt \
          libelf-dev

    - name: å…‹éš†OpenWrtæºç 
      run: |
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "æ­£åœ¨å…‹éš†OpenWrt $BRANCH åˆ†æ”¯ï¼Œä¸º $DEVICE_NAME æ„å»º..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-youhua

    - name: é…ç½®Feedsï¼ˆè½¯ä»¶æºï¼‰
      run: |
        cd openwrt-youhua
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "src-git packages https://git.openwrt.org/feed/packages.git;$BRANCH" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;$BRANCH" >> feeds.conf
        echo "src-git routing https://git.openwrt.org/feed/routing.git;$BRANCH" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: åº”ç”¨åŸºç¡€é…ç½®
      run: |
        cd openwrt-youhua
        cp ../$CONFIG_FILE .config
        make defconfig
        echo "=== $DEVICE_NAME é…ç½®é¢„è§ˆ ==="
        echo "ç›®æ ‡è®¾å¤‡:"
        grep "CONFIG_TARGET.*DEVICE.*youhua" .config || echo "æœªæ‰¾åˆ°è®¾å¤‡é…ç½®"
        echo ""
        echo "å…³é”®åŒ…é…ç½®:"
        grep "^CONFIG_PACKAGE_" .config | head -20

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt-youhua
        echo "å¼€å§‹ä¸‹è½½æ‰€éœ€çš„è½¯ä»¶åŒ…..."
        make -j$(nproc) download
        find dl -size -1024c -exec rm -f {} \;

    - name: ç¼–è¯‘OpenWrtå›ºä»¶
      run: |
        cd openwrt-youhua
        echo "å¼€å§‹ä¸º $DEVICE_NAME ç¼–è¯‘å›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾… (çº¦60-90åˆ†é’Ÿ)..."
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        echo "=== ç¼–è¯‘ç»“æœæ£€æŸ¥ ==="
        if tail -10 build.log | grep -q "make.*Error"; then
          echo "âŒ ç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯"
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
          exit 1
        else
          echo "âœ… ç¼–è¯‘å‘½ä»¤æ‰§è¡Œå®Œæˆ"
        fi

    - name: æŸ¥æ‰¾å¹¶ä¸Šä¼ å›ºä»¶
      run: |
        cd openwrt-youhua
        echo "=== æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶ ==="
        
        # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find bin/targets -type f \( -name "*.bin" -o -name "*.img" -o -name "*youhua*" -o -name "*wr1200*" \) 2>/dev/null || true)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "ğŸ‰ æ‰¾åˆ°å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          
          # å¤åˆ¶å›ºä»¶åˆ°æ ¹ç›®å½•æ–¹ä¾¿ä¸Šä¼ 
          mkdir -p ../firmware-youhua
          for f in $FIRMWARE_FILES; do
            cp "$f" ../firmware-youhua/
          done
          
          ls -lh ../firmware-youhua/
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œæ£€æŸ¥ç›®å½•ç»“æ„:"
          find bin/targets -type f 2>/dev/null | head -20
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      if: env.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: youhua-wr1200js-base-firmware
        path: firmware-youhua/*
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-youhua-base
        path: openwrt-youhua/build.log
        retention-days: 7

    - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youhua-configs
        path: configs/youhua/*
        retention-days: 7
