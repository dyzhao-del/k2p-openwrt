name: "K2P最小化测试构建"

on: workflow_dispatch

env:
  REPO_URL: https://github.com/openwrt/openwrt.git

jobs:
  build-k2p-minimal:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
    
    - name: 2. 创建最小化配置
      run: |
        echo "创建最小化配置..."
        
        cat > minimal-config.config << 'CONFIG'
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt7621=y
CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_PARTSIZE=64
CONFIG_TARGET_KERNEL_PARTSIZE=16

# 绝对最小化包集合
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dropbear=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_fstools=y

# 网络基础
CONFIG_PACKAGE_dnsmasq=y
CONFIG_PACKAGE_iptables=y

# MT7621驱动
CONFIG_PACKAGE_kmod-mt7621=y
CONFIG_PACKAGE_kmod-mt7603=y
CONFIG_PACKAGE_kmod-mt76x2=y
CONFIG_PACKAGE_kmod-cfg80211=y
CONFIG_PACKAGE_kmod-mac80211=y
CONFIG_PACKAGE_wpad-basic=y

# 编译优化
CONFIG_TARGET_OPTIMIZATION="-Os -pipe -mcpu=1004kc"
CONFIG_DEBUG=n
CONFIG
        
        echo "最小化配置创建完成"
        cat minimal-config.config
    
    - name: 3. 设置环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils python3-pip rsync unzip zlib1g-dev file wget quilt libelf-dev
    
    - name: 4. 克隆源码
      run: |
        BRANCH="openwrt-23.05"
        echo "克隆 $BRANCH ..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-k2p-minimal
    
    - name: 5. 配置Feeds
      run: |
        cd openwrt-k2p-minimal
        echo "配置feeds..."
        echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-23.05" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-23.05" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: 6. 应用最小化配置
      run: |
        cd openwrt-k2p-minimal
        echo "应用最小化配置..."
        cp ../minimal-config.config .config
        make defconfig
        
        echo "当前配置:"
        echo "设备: $(grep 'CONFIG_TARGET.*DEVICE.*phicomm' .config)"
        echo "包数量: $(grep '^CONFIG_PACKAGE_' .config | wc -l)"
    
    - name: 7. 下载软件包
      run: |
        cd openwrt-k2p-minimal
        echo "下载软件包..."
        make -j$(nproc) download 2>&1 | tee download.log
        echo "下载完成"
    
    - name: 8. 编译测试
      run: |
        cd openwrt-k2p-minimal
        echo "开始编译测试..."
        
        # 先编译内核和基础包
        echo "阶段1: 编译工具链和内核..."
        make -j$(($(nproc))) tools/compile toolchain/compile 2>&1 | tee compile-stage1.log
        
        echo "阶段2: 编译目标..."
        make -j$(($(nproc))) target/compile 2>&1 | tee compile-stage2.log
        
        echo "阶段3: 编译包..."
        make -j$(($(nproc))) package/compile 2>&1 | tee compile-stage3.log
        
        echo "测试编译完成"
        
        # 检查是否生成了关键文件
        if [ -d "bin/targets/ramips/mt7621" ]; then
          echo "✅ 目标目录已创建"
          ls -la bin/targets/ramips/mt7621/
          echo "TEST_PASSED=true" >> $GITHUB_ENV
        else
          echo "❌ 目标目录未创建"
          echo "TEST_PASSED=false" >> $GITHUB_ENV
        fi
    
    - name: 9. 报告结果
      run: |
        echo "=== 最小化测试结果 ==="
        echo "测试通过: ${{ env.TEST_PASSED || '未知' }}"
        echo ""
        
        if [ "${{ env.TEST_PASSED }}" = "true" ]; then
          echo "✅ 基础编译测试通过"
          echo "说明：K2P核心编译正常，问题在插件依赖"
          echo "下一步：逐步添加插件测试"
        else
          echo "❌ 基础编译失败"
          echo "说明：K2P核心配置有问题"
          echo "需要检查设备名称和基础配置"
        fi
