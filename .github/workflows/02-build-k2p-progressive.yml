name: "K2P渐进式构建测试"

on:
  workflow_dispatch:
    inputs:
      stage:
        description: '构建阶段'
        required: true
        default: '1'
        type: choice
        options:
        - '1'
        - '2'
        - '3'
        - '4'
        - '5'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git

jobs:
  build-k2p-stage:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: 1. 准备环境
      uses: actions/checkout@v4
    
    - name: 2. 创建阶段配置
      id: stage-config
      run: |
        echo "正在创建阶段 ${{ github.event.inputs.stage }} 配置..."
        
        # 创建基础配置文件
        CONFIG_FILE="k2p-stage-${{ github.event.inputs.stage }}.config"
        
        # 阶段1：基础配置
        echo "CONFIG_TARGET_ramips=y" > $CONFIG_FILE
        echo "CONFIG_TARGET_ramips_mt7621=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_IMAGES_GZIP=y" >> $CONFIG_FILE
        echo "CONFIG_TARGET_ROOTFS_PARTSIZE=64" >> $CONFIG_FILE
        echo "CONFIG_TARGET_KERNEL_PARTSIZE=16" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_base-files=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_busybox=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_dropbear=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_firewall=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_fstools=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_dnsmasq=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_iptables=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_kmod-mt7621=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_kmod-mt7603=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_kmod-mt76x2=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_kmod-cfg80211=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_kmod-mac80211=y" >> $CONFIG_FILE
        echo "CONFIG_PACKAGE_wpad-basic=y" >> $CONFIG_FILE
        echo 'CONFIG_TARGET_OPTIMIZATION="-Os -pipe -mcpu=1004kc"' >> $CONFIG_FILE
        echo "CONFIG_DEBUG=n" >> $CONFIG_FILE
        
        # 阶段2：添加LuCI
        if [ "${{ github.event.inputs.stage }}" -ge 2 ]; then
          echo "CONFIG_PACKAGE_luci=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-base=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-compat=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-theme-bootstrap=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-base-zh-cn=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_nano=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_curl=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_openssh-server=y" >> $CONFIG_FILE
        fi
        
        # 阶段3：网络优化
        if [ "${{ github.event.inputs.stage }}" -ge 3 ]; then
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-turboacc-zh-cn=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-upnp-zh-cn=y" >> $CONFIG_FILE
        fi
        
        # 阶段4：管理功能
        if [ "${{ github.event.inputs.stage }}" -ge 4 ]; then
          echo "CONFIG_PACKAGE_luci-app-firewall=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-app-opkg=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-app-ddns=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-ddns-zh-cn=y" >> $CONFIG_FILE
        fi
        
        # 阶段5：额外功能
        if [ "${{ github.event.inputs.stage }}" -ge 5 ]; then
          echo "CONFIG_PACKAGE_luci-app-adblock=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-adblock-zh-cn=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-app-commands=y" >> $CONFIG_FILE
          echo "CONFIG_PACKAGE_luci-i18n-commands-zh-cn=y" >> $CONFIG_FILE
        fi
        
        echo "配置文件 $CONFIG_FILE 创建完成"
        echo "文件大小: $(wc -l < $CONFIG_FILE) 行"
        echo "包数量: $(grep '^CONFIG_PACKAGE_' $CONFIG_FILE | wc -l)"
        
        echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT
    
    - name: 3. 安装编译环境
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils python3-pip rsync unzip zlib1g-dev file wget quilt libelf-dev
    
    - name: 4. 下载OpenWrt源码
      run: |
        echo "克隆OpenWrt 23.05..."
        git clone --depth=1 $REPO_URL -b openwrt-23.05 openwrt-k2p-progressive
    
    - name: 5. 配置软件源
      run: |
        cd openwrt-k2p-progressive
        echo "配置feeds..."
        echo "src-git packages https://git.openwrt.org/feed/packages.git;openwrt-23.05" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;openwrt-23.05" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: 6. 应用配置
      run: |
        cd openwrt-k2p-progressive
        echo "应用阶段配置..."
        cp ../${{ steps.stage-config.outputs.config_file }} .config
        make defconfig
        
        echo "配置信息:"
        echo "设备: $(grep 'CONFIG_TARGET.*DEVICE.*phicomm' .config)"
        echo "总包数: $(grep '^CONFIG_PACKAGE_' .config | wc -l)"
        echo "中文包: $(grep 'luci-i18n.*zh-cn' .config | wc -l)"
    
    - name: 7. 下载软件包
      run: |
        cd openwrt-k2p-progressive
        echo "下载所需软件包..."
        make -j$(nproc) download
        echo "下载完成"
    
    - name: 8. 开始编译
      run: |
        cd openwrt-k2p-progressive
        echo "开始编译阶段 ${{ github.event.inputs.stage }}..."
        
        # 编译并捕获结果
        set +e
        make -j$(($(nproc))) V=s 2>&1 | tee build.log
        COMPILE_RESULT=$?
        set -e
        
        if [ $COMPILE_RESULT -eq 0 ]; then
          echo "✅ 编译成功"
          echo "STAGE_RESULT=success" >> $GITHUB_ENV
        else
          echo "❌ 编译失败，退出代码: $COMPILE_RESULT"
          echo "STAGE_RESULT=failed" >> $GITHUB_ENV
        fi
        
        # 检查固件是否生成
        if [ -d "bin/targets/ramips/mt7621" ]; then
          echo "✅ 固件目录已生成"
          ls -la bin/targets/ramips/mt7621/
          echo "FIRMWARE_GENERATED=true" >> $GITHUB_ENV
        else
          echo "❌ 固件目录未生成"
          echo "FIRMWARE_GENERATED=false" >> $GITHUB_ENV
        fi
    
    - name: 9. 显示编译日志摘要
      if: env.STAGE_RESULT == 'failed'
      run: |
        cd openwrt-k2p-progressive
        echo "=== 编译错误摘要 ==="
        echo ""
        tail -100 build.log | grep -i "error\|fail" | head -20 || echo "未找到明显错误信息"
    
    - name: 10. 生成测试报告
      run: |
        echo "=== K2P渐进式构建测试报告 ==="
        echo "测试阶段: ${{ github.event.inputs.stage }}"
        echo "测试时间: $(date)"
        echo "编译结果: ${{ env.STAGE_RESULT || 'unknown' }}"
        echo "固件生成: ${{ env.FIRMWARE_GENERATED || 'unknown' }}"
        echo ""
        
        case ${{ github.event.inputs.stage }} in
          1)
            echo "阶段1: 基础系统"
            echo "包含: 内核、驱动、基础服务"
            echo "预期结果: 应该通过（已验证）"
            ;;
          2)
            echo "阶段2: LuCI界面"
            echo "包含: Web管理界面、中文支持、基础工具"
            echo "测试目的: 验证LuCI是否正常工作"
            ;;
          3)
            echo "阶段3: 网络优化"
            echo "包含: TurboACC加速、UPnP自动端口映射"
            echo "测试目的: 验证网络优化插件"
            ;;
          4)
            echo "阶段4: 管理功能"
            echo "包含: 防火墙、软件包管理、DDNS"
            echo "测试目的: 验证系统管理插件"
            ;;
          5)
            echo "阶段5: 额外功能"
            echo "包含: 广告过滤、命令执行"
            echo "测试目的: 验证附加功能插件"
            ;;
        esac
        
        echo ""
        if [ "${{ env.STAGE_RESULT }}" = "success" ]; then
          echo "✅ 本阶段测试通过"
          echo "建议: 继续测试下一阶段"
        elif [ "${{ env.STAGE_RESULT }}" = "failed" ]; then
          echo "❌ 本阶段测试失败"
          echo "建议: 停留在本阶段，排查问题"
        fi
