name: Build Plus Firmware

on: workflow_dispatch

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  BASE_CONFIG: configs/base.config
  PLUS_DIFF: configs/plus.diff
  OUTPUT_CONFIG: configs/plus.config
  TARGET: ramips
  SUBTARGET: mt7621
  PROFILE: phicomm_k2p
  OPENWRT_VERSION: "23.05"

jobs:
  build-plus:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Merge Configs
      run: |
        ./scripts/merge-configs.sh \
          $BASE_CONFIG \
          $OUTPUT_CONFIG \
          $PLUS_DIFF
        echo "é…ç½®å·²åˆå¹¶"
        echo "=== åˆå¹¶åçš„é…ç½®é¢„è§ˆ ==="
        head -20 $OUTPUT_CONFIG

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang \
          flex \
          bison \
          g++ \
          gawk \
          gcc-multilib \
          gettext \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python3-distutils \
          python3-pip \
          rsync \
          unzip \
          zlib1g-dev \
          file \
          wget \
          quilt \
          libelf-dev

    - name: Clone OpenWrt Source
      run: |
        BRANCH="openwrt-$OPENWRT_VERSION"
        echo "æ­£åœ¨å…‹éš†OpenWrt $BRANCH åˆ†æ”¯..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-plus

    - name: Configure Feeds
      run: |
        cd openwrt-plus
        BRANCH="openwrt-$OPENWRT_VERSION"
        echo "src-git packages https://git.openwrt.org/feed/packages.git;$BRANCH" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;$BRANCH" >> feeds.conf
        echo "src-git routing https://git.openwrt.org/feed/routing.git;$BRANCH" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Apply Plus Configuration
      run: |
        cd openwrt-plus
    
        echo "=== å½“å‰ç›®å½• ==="
        pwd
        ls -la
    
        echo "=== æ£€æŸ¥é…ç½®æ–‡ä»¶ ==="
        ls -la ../configs/
    
        echo "=== åº”ç”¨é…ç½®å‰æ£€æŸ¥ ==="
    # å…ˆå¤‡ä»½åŸå§‹.configï¼ˆå¦‚æœæœ‰ï¼‰
        [ -f .config ] && cp .config .config.backup
    
    # åº”ç”¨é…ç½®
        echo "æ­£åœ¨åº”ç”¨é…ç½®: $OUTPUT_CONFIG"
        cp ../$OUTPUT_CONFIG .config
    
        echo "=== åº”ç”¨é…ç½®åæ£€æŸ¥ ==="
        echo "é…ç½®æ–‡ä»¶å¤§å°:"
        wc -l .config
        echo ""
    
        echo "è¿è¡Œ defconfig..."
        make defconfig
    
        echo "=== æœ€ç»ˆé…ç½®æ£€æŸ¥ ==="
        echo "1. æ£€æŸ¥TARGET_ROOTFS_PARTSIZE:"
        if grep -q "CONFIG_TARGET_ROOTFS_PARTSIZE" .config; then
        grep "CONFIG_TARGET_ROOTFS_PARTSIZE" .config
        echo "âœ… æ‰¾åˆ°åˆ†åŒºè®¾ç½®"
       else
        echo "âŒ æœªæ‰¾åˆ°åˆ†åŒºè®¾ç½®"
       fi
    
        echo ""
        echo "2. æ£€æŸ¥K2Pè®¾å¤‡é…ç½®:"
       if grep -q "CONFIG_TARGET_ramips_mt7621_DEVICE_phicomm_k2p" .config; then
        echo "âœ… æ‰¾åˆ°K2Pè®¾å¤‡é…ç½®"
       else
        echo "âŒ æœªæ‰¾åˆ°K2Pè®¾å¤‡é…ç½®"
       fi
    
        echo ""
        echo "3. æ£€æŸ¥åŒ…é…ç½®æ•°é‡:"
        echo "æ€»é…ç½®è¡Œæ•°:" $(wc -l < .config)
        echo "åŒ…é…ç½®æ•°é‡:" $(grep "^CONFIG_PACKAGE_" .config | wc -l)
    
        echo ""
        echo "4. å…³é”®é…ç½®é¢„è§ˆ:"
        grep -E "^CONFIG_TARGET_|^CONFIG_PACKAGE_luci-app" .config | head -20   

    - name: Build Plus Firmware
      run: |
        cd openwrt-plus
        echo "å¼€å§‹ç¼–è¯‘Plusç‰ˆå›ºä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…..."
        make -j$(($(nproc) + 1)) V=s 2>&1 | tee build.log | tail -50
        
        # æ£€æŸ¥å›ºä»¶æ˜¯å¦ç”Ÿæˆ
        FIRMWARE_PATH="bin/targets/$TARGET/$SUBTARGET/openwrt-$TARGET-$SUBTARGET-$PROFILE-squashfs-sysupgrade.bin"
        if [ -f "$FIRMWARE_PATH" ]; then
        echo "ğŸ‰ Plusç‰ˆå›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
        ls -lh "$FIRMWARE_PATH"
        echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
        echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ build.log æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚"
        echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        exit 1
        fi

    - name: Upload Firmware Artifacts
      if: env.BUILD_SUCCESS == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: k2p-plus-firmware
        path: openwrt-plus/bin/targets/$TARGET/$SUBTARGET/*.bin
        retention-days: 7

    - name: Upload Build Log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-log-plus
        path: openwrt-plus/build.log
        retention-days: 7

    - name: Upload Merged Config
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: plus-config
        path: $OUTPUT_CONFIG
        retention-days: 7
