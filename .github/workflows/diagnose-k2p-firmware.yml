name: "è¯Šæ–­K2På›ºä»¶ç”Ÿæˆé—®é¢˜"

on: workflow_dispatch

env:
  REPO_URL: https://github.com/openwrt/openwrt.git

jobs:
  diagnose:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
    - name: 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: 2. éªŒè¯K2Pè®¾å¤‡åç§°
      run: |
        echo "=== éªŒè¯K2Pè®¾å¤‡åç§° ==="
        echo ""
        
        # æ£€æŸ¥å½“å‰é…ç½®ä¸­çš„è®¾å¤‡åç§°
        if [ -f "configs/base.config" ]; then
          echo "å½“å‰base.configä¸­çš„è®¾å¤‡é…ç½®:"
          grep "CONFIG_TARGET.*DEVICE" configs/base.config
        else
          echo "é”™è¯¯: base.configä¸å­˜åœ¨"
        fi
        
        echo ""
        echo "æ ¹æ®OpenWrtå®˜æ–¹ï¼ŒK2På¯èƒ½çš„è®¾å¤‡åç§°:"
        echo "1. phicomm_k2p (æœ€å¸¸è§)"
        echo "2. k2p"
        echo "3. phicomm,k2p"
        echo ""
        echo "å»ºè®®: æŸ¥çœ‹OpenWrtæºç ç¡®è®¤æ­£ç¡®åç§°"
        echo "æ–‡ä»¶: target/linux/ramips/image/mt7621.mk"
    
    - name: 3. åˆ›å»ºæµ‹è¯•é…ç½®
      run: |
        echo "åˆ›å»ºæµ‹è¯•é…ç½®..."
        
        # æµ‹è¯•ä¸åŒè®¾å¤‡åç§°
        for DEVICE in "phicomm_k2p" "k2p"; do
          echo "æµ‹è¯•è®¾å¤‡: $DEVICE"
          
          cat > test-$DEVICE.config << CONFIG
CONFIG_TARGET_ramips=y
CONFIG_TARGET_ramips_mt7621=y
CONFIG_TARGET_ramips_mt7621_DEVICE_${DEVICE}=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_TARGET_ROOTFS_PARTSIZE=64
CONFIG_TARGET_KERNEL_PARTSIZE=16
CONFIG_PACKAGE_base-files=y
CONFIG_PACKAGE_busybox=y
CONFIG_PACKAGE_dropbear=y
CONFIG
          
          echo "é…ç½®æ–‡ä»¶ test-$DEVICE.config å·²åˆ›å»º"
          echo ""
        done
    
    - name: 4. è®¾ç½®çŽ¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential git
    
    - name: 5. æ£€æŸ¥OpenWrtæºç ä¸­çš„è®¾å¤‡å®šä¹‰
      run: |
        echo "æ£€æŸ¥OpenWrtæºç ä¸­çš„K2Pè®¾å¤‡å®šä¹‰..."
        echo ""
        
        # å…‹éš†OpenWrtæºç çš„ä¸€å°éƒ¨åˆ†æ¥æ£€æŸ¥
        echo "æ­£åœ¨ä¸‹è½½OpenWrtè®¾å¤‡å®šä¹‰..."
        wget -q https://raw.githubusercontent.com/openwrt/openwrt/openwrt-23.05/target/linux/ramips/image/mt7621.mk -O mt7621.mk || echo "ä¸‹è½½å¤±è´¥"
        
        if [ -f "mt7621.mk" ]; then
          echo "åœ¨mt7621.mkä¸­æœç´¢K2Pè®¾å¤‡å®šä¹‰:"
          echo ""
          grep -i "k2p\|phicomm" mt7621.mk | head -20 || echo "æœªæ‰¾åˆ°K2Pç›¸å…³å®šä¹‰"
          echo ""
          
          echo "æŸ¥çœ‹å®Œæ•´çš„è®¾å¤‡å®šä¹‰:"
          grep -B5 -A10 "define Device/" mt7621.mk | grep -i "k2p\|phicomm" -B5 -A10 || echo "æœªæ‰¾åˆ°å®Œæ•´å®šä¹‰"
        else
          echo "æ— æ³•ä¸‹è½½è®¾å¤‡å®šä¹‰æ–‡ä»¶"
          echo ""
          echo "æ‰‹åŠ¨æ£€æŸ¥å»ºè®®:"
          echo "1. è®¿é—®: https://github.com/openwrt/openwrt"
          echo "2. æŸ¥çœ‹æ–‡ä»¶: target/linux/ramips/image/mt7621.mk"
          echo "3. æœç´¢ 'phicomm' æˆ– 'k2p'"
        fi
    
    - name: 6. åˆ†æžå¯èƒ½çš„é—®é¢˜
      run: |
        echo "=== é—®é¢˜åˆ†æž ==="
        echo ""
        echo "å¦‚æžœç¼–è¯‘æˆåŠŸä½†æ— å›ºä»¶ï¼Œå¯èƒ½åŽŸå› :"
        echo ""
        echo "1. ðŸ“ è®¾å¤‡åç§°é”™è¯¯"
        echo "   - OpenWrtæ‰¾ä¸åˆ°å¯¹åº”è®¾å¤‡å®šä¹‰"
        echo "   - å›ºä»¶ç”Ÿæˆåœ¨å…¶ä»–ç›®å½•"
        echo ""
        echo "2. ðŸ”§ é•œåƒé…ç½®ç¼ºå¤±"
        echo "   - ç¼ºå°‘ CONFIG_TARGET_ROOTFS_SQUASHFS=y"
        echo "   - ç¼ºå°‘ CONFIG_TARGET_IMAGES_GZIP=y"
        echo ""
        echo "3. ðŸš§ æ‰“åŒ…æ­¥éª¤å¤±è´¥"
        echo "   - ç¼–è¯‘å®Œæˆä½†æ‰“åŒ…å‡ºé”™"
        echo "   - æŸ¥çœ‹ç¼–è¯‘æ—¥å¿—å°¾éƒ¨"
        echo ""
        echo "4. ðŸ“‚ æœç´¢å»ºè®®"
        echo "   - åœ¨æ•´ä¸ªç¼–è¯‘ç›®å½•æœç´¢ *.bin æ–‡ä»¶"
        echo "   - æ£€æŸ¥å…¶ä»–å¯èƒ½çš„ç›®å½•ç»“æž„"
        echo ""
        echo "è§£å†³æ–¹æ¡ˆ:"
        echo "1. ç¡®è®¤æ­£ç¡®çš„è®¾å¤‡åç§°"
        echo "2. ç¡®ä¿é•œåƒé…ç½®å®Œæ•´"
        echo "3. æ£€æŸ¥ç¼–è¯‘æ—¥å¿—çš„æ‰“åŒ…é˜¶æ®µ"
