name: "æ„å»ºå‹åWR1200JSä¸­æ–‡å®Œæ•´ç‰ˆ"

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'OpenWrtç‰ˆæœ¬'
        required: true
        default: '23.05'
        type: choice
        options:
        - '23.05'
        - '22.03'

env:
  REPO_URL: https://github.com/openwrt/openwrt.git
  CONFIG_FILE: configs/youhua/full-chinese.config

jobs:
  build-youhua-chinese:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    - name: 2. æ˜¾ç¤ºä¸­æ–‡ç‰ˆç‰¹æ€§
      run: |
        echo "=== å‹åWR1200JSä¸­æ–‡å®Œæ•´ç‰ˆ ==="
        echo ""
        echo "åŒ…å«ç‰¹æ€§:"
        echo "âœ… å®Œæ•´ä¸­æ–‡ç•Œé¢æ”¯æŒ"
        echo "âœ… ä¸­æ–‡æ—¶åŒºè®¾ç½®ï¼ˆä¸Šæµ·ï¼‰"
        echo "âœ… æ‰€æœ‰æ’ä»¶æ±‰åŒ–"
        echo "âœ… å›½å†…è½¯ä»¶æº"
        echo "âœ… ä¸€é”®æ¢æºè„šæœ¬"
        echo ""
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "ä¸­æ–‡è¯­è¨€åŒ…ç»Ÿè®¡:"
          grep -c "luci-i18n.*zh-cn" "$CONFIG_FILE" | xargs echo "å…±æ‰¾åˆ°: ä¸ªä¸­æ–‡è¯­è¨€åŒ…"
          echo ""
          echo "åŒ…å«çš„æ’ä»¶:"
          grep "^CONFIG_PACKAGE_luci-app" "$CONFIG_FILE" | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//'
        fi
    
    - name: 3. è®¾ç½®ç¯å¢ƒ
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib gettext git libncurses5-dev libssl-dev python3 python3-distutils python3-pip rsync unzip zlib1g-dev file wget quilt libelf-dev
    
    - name: 4. å…‹éš†æºç 
      run: |
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "å…‹éš† $BRANCH ..."
        git clone --depth=1 $REPO_URL -b $BRANCH openwrt-youhua-cn
    
    - name: 5. é…ç½®Feeds
      run: |
        cd openwrt-youhua-cn
        BRANCH="openwrt-${{ github.event.inputs.version }}"
        echo "é…ç½®feeds..."
        echo "src-git packages https://git.openwrt.org/feed/packages.git;$BRANCH" > feeds.conf
        echo "src-git luci https://git.openwrt.org/project/luci.git;$BRANCH" >> feeds.conf
        echo "src-git routing https://git.openwrt.org/feed/routing.git;$BRANCH" >> feeds.conf
        ./scripts/feeds update -a
        ./scripts/feeds install -a
    
    - name: 6. åº”ç”¨é…ç½®
      run: |
        cd openwrt-youhua-cn
        echo "åº”ç”¨ä¸­æ–‡ç‰ˆé…ç½®..."
        cp ../$CONFIG_FILE .config
        make defconfig
        
        echo "é…ç½®éªŒè¯:"
        echo "ä¸­æ–‡åŒ…æ•°é‡: $(grep 'luci-i18n.*zh-cn' .config | wc -l)"
        echo "æ—¶åŒºè®¾ç½®: $(grep 'CONFIG_TZ' .config)"
    
    - name: 7. ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt-youhua-cn
        echo "ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆåŒ…å«ä¸­æ–‡è¯­è¨€åŒ…ï¼‰..."
        make -j$(nproc) download
        echo "ä¸‹è½½å®Œæˆ"
    
    - name: 8. ç¼–è¯‘
      run: |
        cd openwrt-youhua-cn
        echo "å¼€å§‹ç¼–è¯‘ä¸­æ–‡å®Œæ•´ç‰ˆ..."
        echo "é¢„è®¡æ—¶é—´: 100-130åˆ†é’Ÿ"
        
        make -j$(($(nproc))) V=s 2>&1 | tee build.log
        
        if tail -20 build.log | grep -q "Signing package index"; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
          echo "BUILD_SUCCESS=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ ç¼–è¯‘å¯èƒ½æœ‰é—®é¢˜"
          echo "BUILD_SUCCESS=false" >> $GITHUB_ENV
        fi
    
    - name: 9. æ£€æŸ¥å›ºä»¶
      run: |
        cd openwrt-youhua-cn
        echo "æ£€æŸ¥ç”Ÿæˆçš„å›ºä»¶..."
        
        TARGET_DIR="bin/targets/ramips/mt7621"
        if [ -d "$TARGET_DIR" ]; then
          echo "âœ… ç›®æ ‡ç›®å½•å­˜åœ¨"
          
          # æŸ¥æ‰¾å›ºä»¶
          for file in "$TARGET_DIR"/*.bin "$TARGET_DIR"/*.img; do
            if [ -f "$file" ]; then
              SIZE_MB=$(ls -l "$file" | awk '{printf "%.1f", $5/1024/1024}')
              echo "ğŸ‰ æ‰¾åˆ°ä¸­æ–‡ç‰ˆå›ºä»¶: $(basename "$file") (${SIZE_MB}MB)"
              mkdir -p ../firmware-chinese
              cp "$file" ../firmware-chinese/
              echo "FIRMWARE_FOUND=true" >> $GITHUB_ENV
              echo "FIRMWARE_SIZE_MB=${SIZE_MB}" >> $GITHUB_ENV
              break
            fi
          done
        fi
    
    - name: 10. ä¸Šä¼ å›ºä»¶
      if: env.FIRMWARE_FOUND == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: youhua-wr1200js-chinese-firmware
        path: firmware-chinese/*
        retention-days: 7
    
    - name: 11. ç”Ÿæˆä¸­æ–‡ç‰ˆæŠ¥å‘Š
      run: |
        echo "=== å‹åWR1200JSä¸­æ–‡å®Œæ•´ç‰ˆæ„å»ºæŠ¥å‘Š ==="
        echo "æ„å»ºæ—¶é—´: $(date)"
        echo "OpenWrtç‰ˆæœ¬: ${{ github.event.inputs.version }}"
        echo "å›ºä»¶å¤§å°: ${FIRMWARE_SIZE_MB:-æœªçŸ¥}MB"
        echo "åŒ…å«ä¸­æ–‡åŒ…: $(grep -c 'luci-i18n.*zh-cn' configs/youhua/full-chinese.config)ä¸ª"
        echo "çŠ¶æ€: ${{ env.FIRMWARE_FOUND == 'true' && 'æˆåŠŸ' || 'å¤±è´¥' }}"
        echo ""
        echo "åˆ·æœºåé¦–æ¬¡ç™»å½•:"
        echo "1. è®¿é—®: http://192.168.1.1"
        echo "2. ç•Œé¢ä¸ºä¸­æ–‡"
        echo "3. æ—¶åŒºå·²è®¾ç½®ä¸ºä¸­å›½æ ‡å‡†æ—¶é—´"
        echo "4. æ‰€æœ‰æ’ä»¶èœå•å·²æ±‰åŒ–"
        echo ""
        echo "å¦‚æœç•Œé¢ä¸æ˜¯ä¸­æ–‡ï¼Œè¯·æ£€æŸ¥:"
        echo "ç³»ç»Ÿ â†’ ç³»ç»Ÿ â†’ è¯­è¨€å’Œç•Œé¢ â†’ é€‰æ‹© ä¸­æ–‡ (ç®€ä½“)"
